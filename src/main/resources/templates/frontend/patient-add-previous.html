<!doctype html>
<html class="landing-pages" data-bs-theme="light" dir="ltr" lang="en">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
    <title>Add New Patient - KiviCare | Medical Clinic & Patient Management</title>

    <!-- Config Options -->
    <meta
        content='{&quot;saveLocal&quot;:&quot;sessionStorage&quot;,&quot;storeKey&quot;:&quot;huisetting&quot;,&quot;setting&quot;:{&quot;app_name&quot;:{&quot;value&quot;:&quot;Kivicare&quot;}}}'
        name="setting_options">
    <!-- Google Font Api KEY-->
    <meta content="AIzaSyBG58yNdAjc20_8jAvLNSVi9E4Xhwjau_k" name="google_font_api">
    <!-- Favicon -->
    <link href="../frontend/assets/images/favicon.ico" rel="shortcut icon" />

    <!-- Library / Plugin Css Build -->
    <link href="../frontend/assets/css/core/libs.min.css" rel="stylesheet" />

    <!-- flaticon css -->
    <link href="../frontend/assets/vendor/flaticon/css/flaticon.css" rel="stylesheet" />

    <!-- font-awesome css -->
    <link href="../frontend/assets/vendor/font-awesome/css/all.min.css" rel="stylesheet" />

    <!-- Flatpickr css -->
    <link href="../frontend/assets/vendor/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />

    <!-- Kivicare Design System Css -->
    <link href="../frontend/assets/css/kivicare.min.css?v=1.4.1" rel="stylesheet" />

    <!-- Custom Css -->
    <link href="../frontend/assets/css/custom.min.css?v=1.4.1" rel="stylesheet" />

    <!-- RTL Css -->
    <link href="../frontend/assets/css/rtl.min.css?v=1.4.1" rel="stylesheet" />

    <!-- Customizer Css -->
    <link href="../frontend/assets/css/customizer.min.css?v=1.4.1" rel="stylesheet" />

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link crossorigin href="https://fonts.gstatic.com" rel="preconnect">
    <link
        href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;1,300;1,400;1,500&display=swap"
        rel="stylesheet">

    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Heebo', sans-serif;
        }

        .patient-add-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 2rem auto;
            max-width: 1200px;
            overflow: hidden;
        }

        .patient-add-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
            position: relative;
        }

        .patient-add-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('../frontend/assets/images/bg-medical-pattern.png') repeat;
            opacity: 0.1;
            z-index: 1;
        }

        .patient-add-header .content {
            position: relative;
            z-index: 2;
        }

        .profile-upload-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 2px dashed #dee2e6;
            transition: all 0.3s ease;
        }

        .profile-upload-section:hover {
            border-color: #667eea;
            background: #f0f3ff;
        }

        .profile-img-edit {
            position: relative;
            margin: 0 auto 1.5rem;
            width: 150px;
            height: 150px;
        }

        .profile-pic {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #fff;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease;
        }

        .profile-pic:hover {
            transform: scale(1.05);
        }

        .upload-icone {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
        }

        .upload-icone:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.6);
        }

        .form-section {
            padding: 2rem;
        }

        .form-floating {
            margin-bottom: 1.5rem;
        }

        .form-control,
        .form-select {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 1rem;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
            transform: translateY(-2px);
        }

        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
        }

        .btn-submit {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 1rem 3rem;
            font-weight: 600;
            font-size: 1.1rem;
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-submit:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
            color: white;
        }

        .social-input {
            position: relative;
        }

        .social-input .form-control {
            padding-left: 3rem;
        }

        .social-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            z-index: 10;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }

        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .step.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: scale(1.1);
        }

        .step.completed {
            background: #28a745;
            color: white;
        }

        .section-divider {
            height: 2px;
            background: linear-gradient(90deg, transparent, #667eea, transparent);
            margin: 2rem 0;
            border: none;
        }

        .success-animation {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .checkmark {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #28a745;
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: scaleIn 0.5s ease-in-out;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0);
            }

            to {
                transform: scale(1);
            }
        }

        /* Grid for dynamic inputs (Step 2) */
        .two-col-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
    </style>
</head>

<body class="body-bg landing-pages">
    <div th:replace="frontend/fragments/header :: header"></div>
    <span class="screen-darken"></span>
    <!-- loader Start -->
    <div id="loading">
        <div class="loader simple-loader">
            <div class="loader-body">
                <img alt="loader" class="light-loader img-fluid" src="../frontend/assets/images/loader.gif" width="200">
            </div>
        </div>
    </div>
    ư
    <!-- loader END -->
    <main class="main-content">
        <div class="container-fluid">
            <div class="patient-add-container">
                <!-- Header Section -->
                <div class="patient-add-header">
                    <div class="content">
                        <h1 class="mb-3">
                            <i class="fas fa-user-plus me-3"></i>
                            Add New Patient
                        </h1>
                        <p class="mb-0 opacity-90">Complete patient registration with medical information</p>
                    </div>
                </div>

                <!-- Step Indicator (chỉ có 2 bước) -->
                <div class="step-indicator mt-4">
                    <div class="step active" id="step1">1</div>
                    <div class="step" id="step2">2</div>
                </div>

                <!-- Start Form -->
                <form id="patientForm">
                    <!-- Step 1: Profile & Basic Info -->
                    <div class="form-step active" id="formStep1">
                        <div class="row">
                            <!-- Profile Upload Section -->
                            <div class="col-lg-4">
                                <div class="profile-upload-section">
                                    <h5 class="text-center mb-4">
                                        <i class="fas fa-camera me-2"></i>
                                        Patient Photo
                                    </h5>
                                    <div class="profile-img-edit">
                                        <img alt="profile-pic" class="profile-pic" id="profilePreview"
                                            src="../frontend/assets/images/avatars/01.png">
                                        <div class="upload-icone">
                                            <svg class="upload-button icon-20" height="20" viewBox="0 0 24 24"
                                                width="20">
                                                <path
                                                    d="M14.06,9L15,9.94L5.92,19H5V18.08L14.06,9M17.66,3C17.41,3 17.15,3.1 16.96,3.29L15.13,5.12L18.88,8.87L20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18.17,3.09 17.92,3 17.66,3M14.06,6.19L3,17.25V21H6.75L17.81,9.94L14.06,6.19Z"
                                                    fill="#ffffff" />
                                            </svg>
                                            <input accept="image/*" class="file-upload" id="avatarUpload" type="file">
                                        </div>
                                        <!-- Input hidden để lưu Base64 -->
                                        <input id="avatarBase64" name="avatarBase64" type="hidden" value="">
                                    </div>
                                    <div class="img-extension text-center">
                                        <small class="text-muted">
                                            Only <strong>.jpg</strong>, <strong>.png</strong>, <strong>.jpeg</strong>
                                            allowed
                                        </small>
                                    </div>
                                </div>
                                <!-- Quick Stats -->
                                <div class="mt-4 p-3 bg-light rounded-3">
                                    <h6 class="mb-3"><i class="fas fa-chart-line me-2"></i>Registration Progress</h6>
                                    <div class="progress mb-2" style="height: 8px;">
                                        <div class="progress-bar bg-gradient" id="progressBar" role="progressbar"
                                            style="width: 50%"></div>
                                    </div>
                                    <small class="text-muted">Step 1 of 2 completed</small>
                                </div>
                            </div>
                            <!-- Basic Information Form -->
                            <div class="col-lg-8">
                                <h5 class="mb-4">
                                    <i class="fas fa-user me-2"></i>
                                    Basic Information
                                </h5>
                                <input name="userId" type="hidden" value="1">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-floating">
                                            <input class="form-control" id="fullName" name="fullName"
                                                placeholder="Enter full name" required type="text">
                                            <label for="fullName"><i class="fas fa-user me-2"></i>Full Name</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-floating">
                                            <input class="form-control" id="email" name="email"
                                                placeholder="Enter email" required type="email">
                                            <label for="email"><i class="fas fa-envelope me-2"></i>Email Address</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-floating">
                                            <input class="form-control" id="phoneNumber" name="phoneNumber"
                                                placeholder="Enter phone number" required type="tel">
                                            <label for="phoneNumber"><i class="fas fa-phone me-2"></i>Phone
                                                Number</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-floating">
                                            <input class="form-control" id="dateOfBirth" name="dateOfBirth" required
                                                type="date">
                                            <label for="dateOfBirth"><i class="fas fa-calendar me-2"></i>Date of
                                                Birth</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-floating">
                                            <select class="form-select" id="gender" name="gender" required>
                                                <option value="">Select Gender</option>
                                                <option value="male">Male</option>
                                                <option value="female">Female</option>
                                                <option value="other">Other</option>
                                            </select>
                                            <label for="gender"><i class="fas fa-venus-mars me-2"></i>Gender</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-floating">
                                            <input class="form-control" id="address" name="address"
                                                placeholder="Enter address" required type="text">
                                            <label for="address"><i
                                                    class="fas fa-map-marker-alt me-2"></i>Address</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-floating">
                                            <select class="form-select" id="familyRelationship"
                                                name="familyRelationship" required>
                                                <option value="">Select Relationship</option>
                                                <option value="self">Self</option>
                                                <option value="wife">Wife</option>
                                                <option value="father">Father</option>
                                                <option value="mother">Mother</option>
                                                <option value="brother">Brother</option>
                                                <option value="sister">Sister</option>
                                                <option value="son">Son</option>
                                                <option value="daughter">Daughter</option>
                                                <option value="grandfather">Grandfather</option>
                                                <option value="grandmother">Grandmother</option>
                                                <option value="cousin">Cousin</option>
                                                <option value="aunt">Aunt</option>
                                                <option value="uncle">Uncle</option>
                                                <option value="other">Other</option>
                                            </select>
                                            <label for="familyRelationship"><i class="fas fa-users me-2"></i>Family
                                                Relationship</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-floating">
                                            <select class="form-select" id="bloodType" name="bloodType" required>
                                                <option value="">Select Blood Type</option>
                                                <option value="A_POSITIVE">A+</option>
                                                <option value="A_NEGATIVE">A-</option>
                                                <option value="B_POSITIVE">B+</option>
                                                <option value="B_NEGATIVE">B-</option>
                                                <option value="AB_POSITIVE">AB+</option>
                                                <option value="AB_NEGATIVE">AB-</option>
                                                <option value="O_POSITIVE">O+</option>
                                                <option value="O_NAGATIVE">O-</option>
                                            </select>
                                            <label for="bloodType"><i class="fas fa-tint me-2"></i>Blood Type</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-end mt-4">
                                    <button class="btn btn-primary" onclick="nextStep()" type="button">
                                        Next Step <i class="fas fa-arrow-right ms-2"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- End Step 1 -->

                    <!-- Step 2: Allergies and Chronic Diseases (Dynamic Inputs) -->
                    <div class="form-step" id="formStep2" style="display: none;">
                        <h5 class="mb-4">
                            <i class="fas fa-info-circle me-2"></i>
                            Additional Information
                        </h5>
                        <div class="two-col-grid">
                            <!-- Allergies Column -->
                            <div>
                                <h6 class="mb-3"><i class="fas fa-exclamation-triangle me-2"></i>Allergies</h6>
                                <div id="allergiesContainer">
                                    <!-- Khởi tạo input 1 -->
                                    <div class="form-floating mb-2">
                                        <input class="form-control dynamic-input" id="allergyInput1" name="allergies[]"
                                            placeholder="Enter allergy" type="text">
                                        <label for="allergyInput1">1. Please enter an allergy</label>
                                    </div>
                                </div>
                            </div>
                            <!-- Chronic Diseases Column -->
                            <div>
                                <h6 class="mb-3"><i class="fas fa-notes-medical me-2"></i>Chronic Diseases</h6>
                                <div id="chronicContainer">
                                    <!-- Khởi tạo input 1 -->
                                    <div class="form-floating mb-2">
                                        <input class="form-control dynamic-input" id="chronicInput1"
                                            name="chronicDiseases[]" placeholder="Enter chronic disease" type="text">
                                        <label for="chronicInput1">1. Please enter a chronic disease</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr class="section-divider">
                        <div class="d-flex justify-content-between mt-4">
                            <button class="btn btn-outline-secondary" onclick="prevStep()" type="button">
                                <i class="fas fa-arrow-left me-2"></i> Previous
                            </button>
                            <button class="btn btn-submit" id="submitBtn" type="submit">
                                <i class="fas fa-user-plus me-2"></i> Register Patient
                            </button>
                        </div>
                    </div>
                    <!-- End Step 2 -->
                </form>
                <!-- End Form -->

                <!-- Success Animation -->
                <div class="success-animation" id="successAnimation">
                    <div class="checkmark">
                        <i class="fas fa-check fa-2x text-white"></i>
                    </div>
                    <h4 class="text-success mb-3">Patient Registered Successfully!</h4>
                    <p class="text-muted mb-4">
                        The patient has been added to the system and can now book appointments.
                    </p>
                    <div class="d-flex gap-3 justify-content-center">
                        <button class="btn btn-primary" onclick="resetForm()" type="button">
                            <i class="fas fa-plus me-2"></i> Add Another Patient
                        </button>
                        <button class="btn btn-outline-primary" onclick="viewPatients()" type="button">
                            <i class="fas fa-list me-2"></i> View All Patients
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <!-- Footer (sử dụng Thymeleaf include nếu cần) -->
    <div th:replace="frontend/fragments/footer :: footer"></div>
    <script>
        let currentStep = 1;
        const totalSteps = 2;
        // Counters cho dynamic inputs
        let allergyCount = 1;
        let chronicCount = 1;

        document.getElementById('avatarUpload').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (evt) {
                    const base64Data = evt.target.result; // Đây là chuỗi Base64
                    // Cập nhật preview
                    document.getElementById('profilePreview').src = base64Data;
                    // Lưu vào input hidden, để gửi xuống backend khi submit form
                    document.getElementById('avatarBase64').value = base64Data;
                };
                reader.readAsDataURL(file);
            }
        });

        document.addEventListener('DOMContentLoaded', function () {
            initializeDynamicInputs();
            setupFormValidation();
        });

        function customValidateFields() {
            let isValid = true;

            // Full Name: Không chứa ký tự đặc biệt, không chứa nhiều khoảng trắng liên tiếp, không bắt đầu/kết thúc bằng space
            const fullName = document.getElementById('fullName');
            const fullNameVal = fullName.value.trim();
            // Regex: chỉ chữ cái, số, khoảng trắng đơn, không ký tự đặc biệt
            const nameRegex = /^[A-Za-zÀ-ỹ0-9 ]+$/;
            if (
                !fullNameVal ||
                !nameRegex.test(fullNameVal) ||
                /\s{2,}/.test(fullName.value) || // nhiều space liên tiếp
                fullName.value.startsWith(' ') ||
                fullName.value.endsWith(' ')
            ) {
                showFieldError(fullName, 'Full name must not contain special characters, leading/trailing/multiple spaces.');
                fullName.classList.add('is-invalid');
                isValid = false;
            } else {
                hideFieldError(fullName);
                fullName.classList.remove('is-invalid');
            }

            // Email: đúng định dạng
            const email = document.getElementById('email');
            const emailVal = email.value.trim();
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailVal || !emailRegex.test(emailVal)) {
                showFieldError(email, 'Please enter a valid email address.');
                email.classList.add('is-invalid');
                isValid = false;
            } else {
                hideFieldError(email);
                email.classList.remove('is-invalid');
            }

            // Phone: chỉ số, đúng 10 ký tự, không chứa space
            const phone = document.getElementById('phoneNumber');
            const phoneVal = phone.value.trim();
            const phoneRegex = /^\d{10}$/;
            if (!phoneVal || !phoneRegex.test(phoneVal)) {
                showFieldError(phone, 'Phone number must be exactly 10 digits and contain only numbers.');
                phone.classList.add('is-invalid');
                isValid = false;
            } else {
                hideFieldError(phone);
                phone.classList.remove('is-invalid');
            }

            // Date of Birth: không được lớn hơn ngày hiện tại
            const dob = document.getElementById('dateOfBirth');
            const dobVal = dob.value;
            if (!dobVal) {
                showFieldError(dob, 'Please select date of birth.');
                dob.classList.add('is-invalid');
                isValid = false;
            } else {
                const today = new Date();
                const inputDate = new Date(dobVal);
                today.setHours(0, 0, 0, 0);
                if (inputDate > today) {
                    showFieldError(dob, 'Date of birth cannot be in the future.');
                    dob.classList.add('is-invalid');
                    isValid = false;
                } else {
                    hideFieldError(dob);
                    dob.classList.remove('is-invalid');
                }
            }

            // Không cho phép các trường required chứa toàn space
            document.querySelectorAll('[required]').forEach(field => {
                if (field.value.trim() === '') {
                    showFieldError(field, 'This field is required.');
                    field.classList.add('is-invalid');
                    isValid = false;
                }
            });

            return isValid;
        }

        // Gọi customValidateFields trong validateCurrentStep
        function validateCurrentStep() {
            const currentFormStep = document.getElementById(`formStep${currentStep}`);
            if (!currentFormStep) return false;

            // Validate các trường required như cũ
            const requiredFields = currentFormStep.querySelectorAll('[required]');
            let isValid = true;

            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                    showFieldError(field, 'This field is required');
                } else {
                    field.classList.remove('is-invalid');
                    hideFieldError(field);
                }
            });

            // Thêm validate custom
            if (!customValidateFields()) isValid = false;

            return isValid;
        }

        function nextStep() {
            if (validateCurrentStep()) {
                if (currentStep < totalSteps) {
                    hideCurrentStep();
                    currentStep++;
                    showCurrentStep();
                    updateStepIndicator();
                    updateProgressBar();
                }
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                hideCurrentStep();
                currentStep--;
                showCurrentStep();
                updateStepIndicator();
                updateProgressBar();
            }
        }

        function hideCurrentStep() {
            const currentFormStep = document.getElementById(`formStep${currentStep}`);
            if (currentFormStep) {
                currentFormStep.style.display = 'none';
                currentFormStep.classList.remove('active');
            }
        }

        function showCurrentStep() {
            const newFormStep = document.getElementById(`formStep${currentStep}`);
            if (newFormStep) {
                newFormStep.style.display = 'block';
                newFormStep.classList.add('active');
            }
        }

        function updateStepIndicator() {
            for (let i = 1; i <= totalSteps; i++) {
                const stepElement = document.getElementById(`step${i}`);
                if (stepElement) {
                    stepElement.classList.remove('active', 'completed');
                    if (i < currentStep) {
                        stepElement.classList.add('completed');
                    } else if (i === currentStep) {
                        stepElement.classList.add('active');
                    }
                }
            }
        }

        function updateProgressBar() {
            const progressBar = document.getElementById('progressBar');
            const progressText = progressBar?.parentElement?.nextElementSibling;
            if (progressBar) {
                const progress = (currentStep / totalSteps) * 100;
                progressBar.style.width = `${progress}%`;
                if (progressText) {
                    progressText.textContent = `Step ${currentStep} of ${totalSteps} completed`;
                }
            }
        }

        function validateCurrentStep() {
            const currentFormStep = document.getElementById(`formStep${currentStep}`);
            if (!currentFormStep) return false;

            const requiredFields = currentFormStep.querySelectorAll('[required]');
            let isValid = true;

            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                    showFieldError(field, 'This field is required');
                } else {
                    field.classList.remove('is-invalid');
                    hideFieldError(field);
                    if (field.type === 'email' && !isValidEmail(field.value)) {
                        field.classList.add('is-invalid');
                        isValid = false;
                        showFieldError(field, 'Please enter a valid email address');
                    } else if (field.type === 'tel' && !isValidPhone(field.value)) {
                        field.classList.add('is-invalid');
                        isValid = false;
                        showFieldError(field, 'Please enter a valid phone number');
                    }
                }
            });
            return isValid;
        }

        function showFieldError(field, message) {
            hideFieldError(field);
            const errorDiv = document.createElement('div');
            errorDiv.className = 'invalid-feedback';
            errorDiv.textContent = message;
            field.parentNode.appendChild(errorDiv);
        }

        function hideFieldError(field) {
            const existingError = field.parentNode.querySelector('.invalid-feedback');
            if (existingError) {
                existingError.remove();
            }
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function isValidPhone(phone) {
            const phoneRegex = /^[\+]?[0-9]{10,15}$/;
            return phoneRegex.test(phone.replace(/[\s\(\)\-]/g, ''));
        }

        function setupFormValidation() {
            const form = document.getElementById('patientForm');
            if (form) {
                form.addEventListener('submit', handleFormSubmission);
            }
        }

        function handleFormSubmission(e) {
            e.preventDefault();
            if (validateCurrentStep()) {
                submitForm();
            }
        }

        function submitForm() {
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Registering...';
            submitBtn.disabled = true;

            // Thu thập dữ liệu như cũ...
            const patientDTO = {
                userId: document.querySelector('input[name="userId"]').value.trim(),
                fullName: document.getElementById('fullName').value.trim(),
                email: document.getElementById('email').value.trim(),
                phoneNumber: document.getElementById('phoneNumber').value.trim(),
                dateOfBirth: document.getElementById('dateOfBirth').value.trim(),
                gender: document.getElementById('gender').value.trim(),
                address: document.getElementById('address').value.trim(),
                familyRelationship: document.getElementById('familyRelationship').value.trim(),
                bloodType: document.getElementById('bloodType').value.trim(),
                avatarBase64: document.getElementById('profilePreview').src
            };

            const allergiesInputs = document.querySelectorAll('input[name="allergies[]"]');
            const allergies = [];
            allergiesInputs.forEach(input => {
                const val = input.value.trim();
                if (val) allergies.push(val);
            });

            const chronicInputs = document.querySelectorAll('input[name="chronicDiseases[]"]');
            const chronicDiseases = [];
            chronicInputs.forEach(input => {
                const val = input.value.trim();
                if (val) chronicDiseases.push(val);
            });

            const medicalProfileDTO = {
                patientId: null,
                allergies: allergies,
                chronicDiseases: chronicDiseases
            };

            const payload = {
                patientDTO: patientDTO,
                medicalProfileDTO: medicalProfileDTO
            };

            fetch('/api/profile', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(payload)
            })
                .then(response => {
                    if (response.ok) {
                        // Nếu status là 200 OK, chuyển hướng sang danh sách bệnh nhân
                        window.location.href = '/patient/showList/1';

                    } else {
                        return response.text().then(msg => {
                            throw new Error(msg);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showErrorMessage('Failed to register patient. Please try again.');
                    resetSubmitButton();
                });
        }

        function showSuccessAnimation() {
            for (let i = 1; i <= totalSteps; i++) {
                const step = document.getElementById(`formStep${i}`);
                if (step) step.style.display = 'none';
            }
            const successAnimation = document.getElementById('successAnimation');
            if (successAnimation) {
                successAnimation.style.display = 'block';
            }
        }

        function showErrorMessage(message) {
            const alert = document.createElement('div');
            alert.className = 'alert alert-danger alert-dismissible fade show position-fixed';
            alert.style.cssText = 'top: 20px; right: 20px; z-index: 1050; max-width: 300px;';
            alert.innerHTML = `<i class="fas fa-exclamation-circle me-2"></i> ${message}
                                 <button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
            document.body.appendChild(alert);
            setTimeout(() => {
                if (alert.parentNode) alert.parentNode.removeChild(alert);
            }, 5000);
        }

        function resetSubmitButton() {
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) {
                submitBtn.innerHTML = '<i class="fas fa-user-plus me-2"></i>Register Patient';
                submitBtn.disabled = false;
            }
        }

        function resetForm() {
            const form = document.getElementById('patientForm');
            if (form) form.reset();
            const profilePreview = document.getElementById('profilePreview');
            if (profilePreview) profilePreview.src = '../frontend/assets/images/avatars/01.png';
            currentStep = 1;
            showCurrentStep();
            updateStepIndicator();
            updateProgressBar();
            const successAnimation = document.getElementById('successAnimation');
            if (successAnimation) successAnimation.style.display = 'none';
        }

        function viewPatients() {
            window.location.href = '/patients';
        }

        // ---------------- Dynamic Inputs for Step 2 ---------------- //
        function addDynamicInput(container, typePrefix, count, labelText) {
            const inputs = container.querySelectorAll('input');
            if (inputs[inputs.length - 1].value.trim() === '') return;
            const div = document.createElement('div');
            div.className = 'form-floating';
            div.style.marginTop = '10px';
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-control dynamic-input';
            input.id = `${typePrefix}Input${count}`;
            input.name = `${typePrefix}Diseases[]`;
            input.placeholder = `Enter ${typePrefix === 'allergy' ? 'allergy' : 'chronic disease'}`;
            const label = document.createElement('label');
            label.htmlFor = input.id;
            label.innerHTML = `${count}. ${labelText}`;
            div.appendChild(input);
            div.appendChild(label);
            container.appendChild(div);
        }

        function initializeBlurEvent(container, typePrefix, labelText) {
            container.addEventListener('blur', function (e) {
                if (e.target && e.target.classList.contains('dynamic-input')) {
                    const inputs = container.querySelectorAll('input.dynamic-input');
                    if (e.target.value.trim() === "" && inputs.length > 1) {
                        e.target.parentElement.remove();
                        updateInputNumbers(container, typePrefix, labelText);
                        if (typePrefix === 'allergy') {
                            allergyCount = container.querySelectorAll('input.dynamic-input').length;
                        } else if (typePrefix === 'chronic') {
                            chronicCount = container.querySelectorAll('input.dynamic-input').length;
                        }
                    }
                }
            }, true);
        }

        function updateInputNumbers(container, typePrefix, labelText) {
            const inputs = container.querySelectorAll('input.dynamic-input');
            inputs.forEach((input, index) => {
                const newCount = index + 1;
                input.id = `${typePrefix}Input${newCount}`;
                const label = input.parentElement.querySelector('label');
                if (label) {
                    label.htmlFor = input.id;
                    label.innerHTML = `${newCount}. ${labelText}`;
                }
            });
        }

        function initializeDynamicInputs() {
            const allergiesContainer = document.getElementById('allergiesContainer');
            allergiesContainer.addEventListener('input', function (e) {
                if (e.target && e.target.classList.contains('dynamic-input')) {
                    const inputs = allergiesContainer.querySelectorAll('input');
                    const lastInput = inputs[inputs.length - 1];
                    if (lastInput.value.trim() !== '') {
                        addDynamicInput(allergiesContainer, 'allergy', ++allergyCount, 'Please enter an allergy');
                    }
                }
            });
            initializeBlurEvent(allergiesContainer, 'allergy', 'Please enter an allergy');

            const chronicContainer = document.getElementById('chronicContainer');
            chronicContainer.addEventListener('input', function (e) {
                if (e.target && e.target.classList.contains('dynamic-input')) {
                    const inputs = chronicContainer.querySelectorAll('input');
                    const lastInput = inputs[inputs.length - 1];
                    if (lastInput.value.trim() !== '') {
                        addDynamicInput(chronicContainer, 'chronic', ++chronicCount, 'Please enter a chronic disease');
                    }
                }
            });
            initializeBlurEvent(chronicContainer, 'chronic', 'Please enter a chronic disease');
        }

        // ---------------- End Dynamic Inputs ---------------- //

        document.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' && !e.target.matches('textarea')) {
                e.preventDefault();
                if (currentStep < totalSteps) {
                    nextStep();
                } else {
                    document.getElementById('patientForm').dispatchEvent(new Event('submit'));
                }
            }
        });
    </script>
    <!-- Live Customizer end -->
    <!-- Library Bundle Script -->
    <script src="../frontend/assets/js/core/libs.min.js"></script>
    <!-- Plugin Scripts -->
    <script src="../frontend/assets/vendor/flatpickr/dist/flatpickr.min.js"></script>
    <script defer src="../frontend/assets/js/plugins/flatpickr.js"></script>
    <script src="../frontend/assets/js/plugins/slider-tabs.js"></script>
    <script defer src="../frontend/assets/js/plugins/fslightbox.js"></script>
    <script defer src="../frontend/assets/js/plugins/select2.js"></script>
    <script src="../frontend/assets/vendor/lodash/lodash.min.js"></script>
    <script src="../frontend/assets/js/iqonic-script/utility.min.js"></script>
    <script src="../frontend/assets/js/iqonic-script/setting.min.js"></script>
    <script src="../frontend/assets/js/setting-init.js"></script>
    <script src="../frontend/assets/js/core/external.min.js"></script>
    <script defer src="../frontend/assets/js/charts/widgetcharts.js?v=1.4.1"></script>
    <script defer src="../frontend/assets/js/charts/dashboard.js?v=1.4.1"></script>
    <script defer src="../frontend/assets/js/kivicare.js?v=1.4.1"></script>
    <script defer src="../frontend/assets/js/kivicare-advance.js?v=1.4.1"></script>
    <script defer src="../frontend/assets/js/sidebar.js?v=1.4.1"></script>
    <script defer src="../frontend/assets/js/solid-icon-search-filter.js?v=1.4.1"></script>
</body>

</html>