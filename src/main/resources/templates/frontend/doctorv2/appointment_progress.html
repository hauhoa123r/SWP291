<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Appointment In Progress - KiviCare</title>
    <!-- Enhanced Custom Styles -->
    <link rel="stylesheet" href="enhanced-buttons.css" />

    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 80px;
        }

        .progress-header {
            background: var(--bs-primary);
            color: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .progress-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            margin-bottom: 1.5rem;
        }

        .progress-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
        }

        .patient-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #fff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .info-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid #667eea;
        }

        /* Enhanced Bootstrap button hover effects */
        .btn {
            border-radius: 8px;
            padding: 12px 24px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
            width: 100%;
            border: none;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            filter: brightness(110%);
        }

        .btn:active {
            transform: translateY(0);
        }

        /* Ensure proper hover states for Bootstrap buttons */
        .btn:hover {
            filter: brightness(110%);
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 500;
            font-size: 0.85rem;
        }

        .status-in-progress {
            background: var(--bs-warning);
            color: white;
        }

        .timeline-step {
            position: relative;
            padding-left: 2rem;
            margin-bottom: 1.5rem;
        }

        .timeline-step::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0.5rem;
            width: 12px;
            height: 12px;
            background: #667eea;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 0 3px #667eea33;
        }

        .timeline-step.active::before {
            background: #28a745;
            box-shadow: 0 0 0 3px #28a74533;
        }

        .timeline-step::after {
            content: '';
            position: absolute;
            left: 5px;
            top: 1.5rem;
            width: 2px;
            height: calc(100% + 0.5rem);
            background: #dee2e6;
        }

        .timeline-step:last-child::after {
            display: none;
        }

        .vitals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .vital-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .vital-card:hover {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .vital-icon {
            width: 50px;
            height: 50px;
            background: var(--bs-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            color: white;
            font-size: 1.5rem;
        }

        .search-tests {
            border-radius: 25px;
            border: 2px solid #e9ecef;
            padding: 12px 20px;
            margin-bottom: 1rem;
        }

        .search-tests:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .test-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .test-item:hover {
            background: #f8f9fa;
            border-color: #667eea;
        }

        .test-item.selected {
            background: var(--bs-primary);
            color: white;
            border-color: var(--bs-primary);
        }
    </style>
</head>

<body>
    <div class="container-fluid py-4">
  <div class="row">
    <!-- Bên trái: Profile & Tiền sử -->
    <div class="col-lg-4 mb-4" id="patientInfoContainer">

    </div>

    <!-- Bên phải: Quy trình khám -->
    <div class="col-lg-8">
      <div class="card mb-3">
          <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
              <span><i class="fas fa-procedures me-2"></i>Quy trình khám bệnh</span>
              <span id="examDuration" class="badge bg-warning text-dark"></span>
          </div>
        <div class="card-body">
          <!-- Tab nav -->
          <ul class="nav nav-pills mb-3" id="examTab" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="step1-tab" data-bs-toggle="pill" data-bs-target="#step1" type="button" role="tab">1. Hỏi bệnh</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="step2-tab" data-bs-toggle="pill" data-bs-target="#step2" type="button" role="tab">2. Khám lâm sàng</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="step3-tab" data-bs-toggle="pill" data-bs-target="#step3" type="button" role="tab">3. Cận lâm sàng</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="step4-tab" data-bs-toggle="pill" data-bs-target="#step4" type="button" role="tab">4. Chẩn đoán</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="step5-tab" data-bs-toggle="pill" data-bs-target="#step5" type="button" role="tab">5. Điều trị</button>
            </li>
          </ul>
          <!-- Tab content -->
          <div class="tab-content" id="examTabContent">
            <div class="tab-pane fade show active" id="step1" role="tabpanel">
              <!-- Hỏi bệnh -->
              <form>
                <div class="mb-3">
                  <label class="form-label">Lý do đến khám</label>
                  <input type="text" class="form-control" value="Đau đầu, chóng mặt">
                </div>
                <div class="mb-3">
                  <label class="form-label">Diễn biến</label>
                  <textarea class="form-control" rows="2">Đau tăng dần, không sốt</textarea>
                </div>
                <div class="mb-3">
                  <label class="form-label">Liên quan yếu tố khác</label>
                  <input type="text" class="form-control" value="Căng thẳng công việc">
                </div>
                <div class="mb-3">
                  <label class="form-label">Mức độ ảnh hưởng</label>
                  <input type="text" class="form-control" value="Khó tập trung làm việc">
                </div>
              </form>
            </div>
            <div class="tab-pane fade" id="step2" role="tabpanel">
              <!-- Khám lâm sàng -->
              <form>
                <div class="mb-3">
                  <label class="form-label">Toàn thân</label>
                  <textarea class="form-control" rows="2"></textarea>
                </div>
                <div class="mb-3">
                  <label class="form-label">Hô hấp</label>
                  <textarea class="form-control" rows="2"></textarea>
                </div>
                <div class="mb-3">
                  <label class="form-label">Tuần hoàn</label>
                  <textarea class="form-control" rows="2"></textarea>
                </div>
                <!-- ... các hệ khác ... -->
              </form>
            </div>
            <div class="tab-pane fade" id="step3" role="tabpanel">
              <!-- Cận lâm sàng -->
              <form>
                <div class="mb-3">
                  <label class="form-label">Chỉ định xét nghiệm</label>
                  <input type="text" class="form-control">
                </div>
                <div class="mb-3">
                  <label class="form-label">Chẩn đoán hình ảnh</label>
                  <input type="text" class="form-control">
                </div>
                <div class="mb-3">
                  <label class="form-label">Nội soi</label>
                  <input type="text" class="form-control">
                </div>
              </form>
            </div>
            <div class="tab-pane fade" id="step4" role="tabpanel">
              <!-- Chẩn đoán -->
              <form>
                <div class="mb-3">
                  <label class="form-label">Chẩn đoán sơ bộ</label>
                  <input type="text" class="form-control">
                </div>
                <div class="mb-3">
                  <label class="form-label">Chẩn đoán phân biệt</label>
                  <input type="text" class="form-control">
                </div>
                <div class="mb-3">
                  <label class="form-label">Chẩn đoán xác định</label>
                  <input type="text" class="form-control">
                </div>
              </form>
            </div>
            <div class="tab-pane fade" id="step5" role="tabpanel">
              <!-- Điều trị -->
              <form>
                <div class="mb-3">
                  <label class="form-label">Phác đồ điều trị</label>
                  <textarea class="form-control" rows="2"></textarea>
                </div>
                <div class="mb-3">
                  <label class="form-label">Dặn dò, theo dõi</label>
                  <textarea class="form-control" rows="2"></textarea>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
      <!-- Có thể thêm nút lưu, xác nhận, in bệnh án... -->
    </div>
  </div>
</div>

    <!-- Test Request Modal -->
    <div class="modal fade" id="testRequestModal" tabindex="-1" aria-labelledby="testRequestModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="testRequestModalLabel">
                        <i class="fas fa-vial me-2"></i>Request Laboratory Tests
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <input type="text" class="form-control search-tests" id="testSearch"
                            placeholder="Search for tests..." oninput="searchTests()">
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <h6 class="mb-3">Available Tests</h6>
                            <div id="testsList">
                                <!-- Tests will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <h6 class="mb-2">Selected Tests</h6>
                        <div id="selectedTests" class="alert alert-info">
                            No tests selected yet
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitTestRequest()">
                        <i class="fas fa-check me-2"></i>Request Selected Tests
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="../dashboard/assets/js/core/libs.min.js"></script>
    <script src="../dashboard/assets/js/kivicare.js"></script>

    <script>
        // Get appointment ID from URL or use default for demo
        const appointmentId = new URLSearchParams(window.location.search).get('id') || 1;
        let selectedTests = [];

        // Sample test data
        const availableTests = [
            { id: 1, name: "Complete Blood Count (CBC)", category: "Hematology" },
            { id: 2, name: "Basic Metabolic Panel", category: "Chemistry" },
            { id: 3, name: "Lipid Panel", category: "Chemistry" },
            { id: 4, name: "Thyroid Function Tests", category: "Endocrinology" },
            { id: 5, name: "Liver Function Tests", category: "Chemistry" },
            { id: 6, name: "Kidney Function Tests", category: "Chemistry" },
            { id: 7, name: "Blood Glucose", category: "Chemistry" },
            { id: 8, name: "Hemoglobin A1c", category: "Chemistry" },
            { id: 9, name: "Vitamin D", category: "Vitamins" },
            { id: 10, name: "Vitamin B12", category: "Vitamins" }
        ];

        // Sample patient data for demonstration
        const samplePatientData = {
            patientEntityId: "P001",
            patientEntityFullName: "John Smith",
            patientEntityPhoneNumber: "+1 234-567-8900",
            patientEntityEmail: "john.smith@email.com",
            patientEntityAddress: "123 Main St, Cityville, State 12345",
            patientEntityBirthdate: "1988-05-15",
            patientEntityAvatarUrl: "https://via.placeholder.com/120x120/667eea/white?text=JS",
            date: "2024-01-15 09:30:00",
            symptoms: "",
            diagnosis: ""
        };

        // Initialize page
        document.addEventListener('DOMContentLoaded', function () {
            loadPatientData();
            loadAvailableTests();
            updateStartTime();
            setupFormValidation();
        });

        // Replace this function in your HTML file
        function loadPatientData() {
            const appointmentId = new URLSearchParams(window.location.search).get('id') || 1;
            fetch(`/appointments/in-progress/${appointmentId}`)
                .then(response => response.json())
                .then(data => renderPatientInfo(data))
                .catch(error => {
                    console.error('Error loading patient data:', error);
                    document.getElementById('patientInfoContainer').innerHTML = '<div class="alert alert-danger">Error loading patient information.</div>';
                });
        }
        function renderPatientInfo(data) {
            const container = document.getElementById('patientInfoContainer');
            container.innerHTML = `
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <i class="fas fa-user me-2"></i>Patient Profile
            </div>
            <div class="card-body text-center">
                <img src="${data.patientEntityAvatarUrl || 'https://via.placeholder.com/120x120/667eea/white?text=U'}" class="patient-avatar mb-2">
                <h5 class="mb-1">${data.patientEntityFullName || ''}</h5>
                <div class="text-muted mb-2">
                    ${data.patientEntityGender === 'MALE' ? 'Male' : data.patientEntityGender === 'FEMALE' ? 'Female' : ''}
                    ${data.patientEntityBirthdate ? ', ' + calculateAge(data.patientEntityBirthdate) + ' years' : ''}
                </div>
                <div class="mb-2"><i class="fas fa-phone me-1"></i> ${data.patientEntityPhoneNumber || ''}</div>
                <div class="mb-2"><i class="fas fa-envelope me-1"></i> ${data.patientEntityEmail || ''}</div>
                <div class="mb-2"><i class="fas fa-map-marker-alt me-1"></i> ${data.patientEntityAddress || ''}</div>
                <div class="mb-2"><i class="fas fa-id-card me-1"></i> ID: ${data.patientEntityId || ''}</div>
            </div>
        </div>
    `;
            if (data.durationMinutes) {
                startCountdown(data.durationMinutes);
            }
        }
        // Helper to calculate age from birthdate string (yyyy-MM-dd)
        function calculateAge(birthdate) {
            const birth = new Date(birthdate);
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const m = today.getMonth() - birth.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }

        function startCountdown(durationMinutes) {
            const durationElem = document.getElementById('examDuration');
            let remaining = durationMinutes * 60; // seconds

            function updateTimer() {
                const min = Math.floor(remaining / 60);
                const sec = remaining % 60;
                durationElem.textContent = `Time left: ${min}:${sec.toString().padStart(2, '0')} min`;
                if (remaining > 0) {
                    remaining--;
                    setTimeout(updateTimer, 1000);
                } else {
                    durationElem.textContent = 'Time is up!';
                    durationElem.classList.remove('bg-warning', 'text-dark');
                    durationElem.classList.add('bg-danger', 'text-white');
                }
            }
            updateTimer();
        }

        function loadAvailableTests() {
            const testsList = document.getElementById('testsList');
            testsList.innerHTML = availableTests.map(test => `
                <div class="test-item" onclick="toggleTest(${test.id}, '${test.name}')">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${test.name}</h6>
                            <small class="text-muted">${test.category}</small>
                        </div>
                        <i class="fas fa-plus"></i>
                    </div>
                </div>
            `).join('');
        }

        function updateStartTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
            document.getElementById('startTime').textContent = `Started at ${timeString}`;
        }

        function setupFormValidation() {
            const symptomsField = document.getElementById('symptoms');
            const diagnosisField = document.getElementById('diagnosis');
            const vitalFields = ['heartRate', 'temperature', 'bloodPressure', 'oxygenSat'];

            symptomsField.addEventListener('input', function () {
                if (this.value.trim()) {
                    updateTimelineStep('symptomsStep', 'Symptoms documented');
                }
            });

            diagnosisField.addEventListener('input', function () {
                if (this.value.trim()) {
                    updateTimelineStep('diagnosisStep', 'Diagnosis completed');
                }
            });

            vitalFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                field.addEventListener('input', function () {
                    checkVitalsCompletion();
                });
            });
        }

        function checkVitalsCompletion() {
            const vitalFields = ['heartRate', 'temperature', 'bloodPressure', 'oxygenSat'];
            const completedFields = vitalFields.filter(fieldId => {
                const field = document.getElementById(fieldId);
                return field.value.trim() !== '';
            });

            if (completedFields.length > 0) {
                updateTimelineStep('vitalsStep', `${completedFields.length}/4 vital signs recorded`);
            }
        }

        function updateTimelineStep(stepId, message) {
            const step = document.getElementById(stepId);
            if (step) {
                step.classList.add('active');
                const timeText = step.querySelector('p');
                if (timeText) {
                    const now = new Date();
                    const timeString = now.toLocaleTimeString('en-US', {
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: true
                    });
                    timeText.textContent = `${message} at ${timeString}`;
                    timeText.classList.remove('text-muted');
                    timeText.classList.add('text-success');
                }
            }
        }

        function completeExamination() {
            const symptoms = document.getElementById('symptoms').value.trim();
            const diagnosis = document.getElementById('diagnosis').value.trim();

            if (!symptoms || !diagnosis) {
                alert('Please fill in both symptoms and diagnosis before completing the examination.');
                return;
            }

            if (confirm('Are you sure you want to complete this examination?')) {
                updateAppointment({ status: 'COMPLETED' }); updateTimelineStep('completionStep', 'Examination completed');

                const actionButtons = document.querySelectorAll('.btn:not([onclick*="goBack"])');
                actionButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('opacity-50');
                });

                setTimeout(() => {
                    alert('Examination completed successfully!');
                    window.location.href = '/doctor/appointments';
                }, 1000);
            }
        }

        function waitForTestResults() {
            if (confirm('Pause examination to wait for test results?')) {
                updateAppointment({ status: 'WAITING_RESULT' });
                alert('Examination paused. Patient will be notified when results are available.');
            }
        }

        function requestTests() {
            const modal = new bootstrap.Modal(document.getElementById('testRequestModal'));
            modal.show();
        }

        function prescribeMedication() {
            if (confirm('Complete examination and proceed to prescription?')) {
                updateAppointment({ status: 'COMPLETED', type: 'prescribed' });
                alert('Redirecting to prescription module...');
            }
        }

        function toggleTest(testId, testName) {
            const testElement = event.currentTarget;
            const icon = testElement.querySelector('i');

            if (selectedTests.includes(testId)) {
                selectedTests = selectedTests.filter(id => id !== testId);
                testElement.classList.remove('selected');
                icon.className = 'fas fa-plus';
            } else {
                selectedTests.push(testId);
                testElement.classList.add('selected');
                icon.className = 'fas fa-check';
            }

            updateSelectedTestsDisplay();
        }

        function updateSelectedTestsDisplay() {
            const selectedTestsDiv = document.getElementById('selectedTests');

            if (selectedTests.length === 0) {
                selectedTestsDiv.innerHTML = 'No tests selected yet';
                selectedTestsDiv.className = 'alert alert-info';
            } else {
                const selectedTestNames = selectedTests.map(id => {
                    const test = availableTests.find(t => t.id === id);
                    return test ? test.name : '';
                }).filter(name => name);

                selectedTestsDiv.innerHTML = `
                    <strong>Selected Tests (${selectedTests.length}):</strong><br>
                    ${selectedTestNames.map(name => `• ${name}`).join('<br>')}
                `;
                selectedTestsDiv.className = 'alert alert-success';
            }
        }

        function searchTests() {
            const searchTerm = document.getElementById('testSearch').value.toLowerCase();
            const filteredTests = availableTests.filter(test =>
                test.name.toLowerCase().includes(searchTerm) ||
                test.category.toLowerCase().includes(searchTerm)
            );

            const testsList = document.getElementById('testsList');
            testsList.innerHTML = filteredTests.map(test => `
                <div class="test-item ${selectedTests.includes(test.id) ? 'selected' : ''}" 
                     onclick="toggleTest(${test.id}, '${test.name}')">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${test.name}</h6>
                            <small class="text-muted">${test.category}</small>
                        </div>
                        <i class="fas fa-${selectedTests.includes(test.id) ? 'check' : 'plus'}"></i>
                    </div>
                </div>
            `).join('');
        }

        function submitTestRequest() {
            if (selectedTests.length === 0) {
                alert('Please select at least one test.');
                return;
            }

            console.log('Requesting tests:', selectedTests);

            const modal = bootstrap.Modal.getInstance(document.getElementById('testRequestModal'));
            modal.hide();

            alert(`Successfully requested ${selectedTests.length} lab test(s). Results will be available within 24-48 hours.`);

            selectedTests = [];
            updateSelectedTestsDisplay();
            loadAvailableTests();
        }

        function updateAppointment(updateData) {
            const appointmentDTO = {
                id: appointmentId,
                patient: {
                    id: document.getElementById('patientId').textContent.replace('#', ''),
                    fullName: document.getElementById('fullName').value,
                    phoneNumber: document.getElementById('phoneNumber').value,
                    email: document.getElementById('email').value,
                    address: document.getElementById('address').value,
                    birthdate: document.getElementById('birthdate').value,
                    avatarUrl: document.getElementById('patientAvatar').src
                },
                date: document.getElementById('datetime').value,
                symptoms: document.getElementById('symptoms').value,
                diagnosis: document.getElementById('diagnosis').value,
                treatmentNotes: document.getElementById('treatmentNotes').value,
                vitals: {
                    heartRate: document.getElementById('heartRate').value,
                    temperature: document.getElementById('temperature').value,
                    bloodPressure: document.getElementById('bloodPressure').value,
                    oxygenSat: document.getElementById('oxygenSat').value
                }
            };

            console.log('Updating appointment:', appointmentDTO);
            return Promise.resolve(appointmentDTO);
        }

        function goBack() {
            if (confirm('Are you sure you want to leave this examination? Any unsaved changes will be lost.')) {
                window.location.href = '/doctor/appointments';
            }
        }
    </script>
</body>
</html>