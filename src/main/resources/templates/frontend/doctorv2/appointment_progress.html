<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Appointment In Progress - KiviCare</title>
    <!-- Enhanced Custom Styles -->
    <link rel="stylesheet" href="enhanced-buttons.css" />

    <style>
        :root {
    --primary: #4a6cfa;
    --secondary: #6c757d;
    --success: #28a745;
    --warning: #ffc107;
    --danger: #dc3545;
    --light: #f8f9fa;
    --border-radius: 12px;
    --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    --shadow-hover: 0 6px 25px rgba(0, 0, 0, 0.12);
}

body {
    background-color: var(--light);
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    padding-top: 40px;
    line-height: 1.6;
}

.container-fluid {
    max-width: 100%;
}

.row.g-0 {
    gap: 2rem 0;
}

.col-lg-4 {
    /* padding-right: 2rem !important; */
}

.col-lg-8 {
    /* padding-left: 2rem !important; */
}

@media (max-width: 991.98px) {
    .col-lg-4,
    .col-lg-8 {
        padding-left: 0 !important;
        padding-right: 0 !important;
    }
    .row.g-0 {
        gap: 0;
    }
}

.card {
    border: none;
    box-shadow: var(--shadow);
    background: #fff;
}


.card-header {
    border-radius: var(--border-radius) var(--border-radius) 0 0;
    padding: 1.25rem 1.5rem;
    background: linear-gradient(135deg, var(--bs-primary), #7f9cff);
    color: white;
    font-weight: 600;
    font-size: 1.1rem;
}



.info-item {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    border-left: 4px solid var(--primary);
    font-size: 1rem;
    color: #333;
}

.btn {
    border-radius: 8px;
    padding: 0.75rem 1.5rem;
    font-weight: 500;
    transition: all 0.3s ease;
    border: none;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
    filter: brightness(110%);
}

.status-badge {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 500;
    font-size: 0.9rem;
}

.status-in-progress {
    background: var(--warning);
    color: white;
}

.timeline {
    position: relative;
    padding-left: 3rem;
    margin-bottom: 2rem;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 1.25rem;
    top: 0;
    bottom: 0;
    width: 4px;
    background: #dee2e6;
}

.timeline-step {
    position: relative;
    margin-bottom: 2rem;
}

.timeline-step::before {
    content: '';
    position: absolute;
    left: -2.75rem;
    top: 0.5rem;
    width: 20px;
    height: 20px;
    background: var(--primary);
    border-radius: 50%;
    border: 4px solid white;
    box-shadow: 0 0 0 4px rgba(74, 108, 250, 0.2);
}

.timeline-step.completed::before {
    background: var(--success);
    box-shadow: 0 0 0 4px rgba(40, 167, 69, 0.2);
}

.timeline-step.active::before {
    background: var(--warning);
    box-shadow: 0 0 0 4px rgba(255, 193, 7, 0.2);
}

.timeline-step .card-header {
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 1rem;
    background: #f8f9fa;
    color: var(--primary);
    border-radius: var(--border-radius) var(--border-radius) 0 0;
    font-weight: 600;
    font-size: 1.05rem;
}

.timeline-step .card-body {
    display: none;
    background: #fff;
    border-radius: 0 0 var(--border-radius) var(--border-radius);
}

.timeline-step.active .card-body {
    display: block;
}

.form-control, .form-select {
    border-radius: 8px;
    border: 1px solid #ced4da;
    padding: 0.75rem;
    font-size: 1rem;
}

.form-control:focus, .form-select:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 0.2rem rgba(74, 108, 250, 0.25);
}

.plain-list {
    list-style-type: disc;
    padding-left: 1.5rem;
    margin-bottom: 0.5rem;
}

.plain-list li {
    margin-bottom: 0.25rem;
    font-size: 0.95rem;
    color: #333;
}

.symptom-list .list-group-item {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    border: none;
    border-bottom: 1px solid #f0f0f0;
    background: white;
}

.symptom-list .list-group-item:hover {
    background: var(--light);
}

.symptom-list .fa-exclamation-circle {
    font-size: 1.1rem;
    margin-top: 0.25rem;
    color: var(--danger);
}

.symptom-list .badge {
    font-size: 0.8rem;
    padding: 0.4rem 0.8rem;
}

.search-tests {
    border-radius: 25px;
    border: 2px solid #e9ecef;
    padding: 0.75rem 1.25rem;
}

.search-tests:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 0.2rem rgba(74, 108, 250, 0.25);
}

.test-item {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.75rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.test-item:hover {
    background: var(--light);
    border-color: var(--primary);
}

.test-item.selected {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}
#examTab {
    background: #fff;
    min-height: 100vh;
    padding: 1rem 0.2rem 1rem 0.2rem !important;
    border-radius: 0px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.03);
    width: 100%;
}
#examTab .nav-link {
    background: none;
    color: #333;
    border: none;
    border-left: 3px solid transparent;
    border-radius: 0 4px 4px 0;
    font-size: 0.97rem;
    font-weight: 500;
    padding: 0.25rem 0.5rem 0.25rem 0.5rem;
    margin-bottom: 0.1rem;
    display: flex;
    align-items: center;
    gap: 0.3rem;
    min-height: 32px;
    transition: background 0.15s, color 0.15s, border-color 0.15s;
}
#examTab .nav-link i {
    width: 22px;
    height: 22px;
    font-size: 1rem;
    border: 1px solid #e0e6ed;
    border-radius: 4px;
    background: #f8f9fa;
    color: #4a6cfa;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 0.3rem;
}
#examTab .nav-link.active,
#examTab .nav-link:focus,
#examTab .nav-link:hover {
    background: #f4f7ff;
    color: #4a6cfa;
    border-left: 3px solid #4a6cfa;
}
#examTab .nav-link.active i,
#examTab .nav-link:focus i,
#examTab .nav-link:hover i {
    border-color: #4a6cfa;
    background: #eaf0ff;
    color: #4a6cfa;
}
@media (max-width: 991.98px) {
    #examTab {
        flex-direction: row;
        min-height: unset;
        border-radius: 0;
        box-shadow: none;
        padding: 0.3rem !important;
    }
    #examTab .nav-link {
        border-left: none;
        border-bottom: 3px solid transparent;
        border-radius: 4px 4px 0 0;
        margin-bottom: 0;
        margin-right: 0.1rem;
        font-size: 0.95rem;
        padding: 0.3rem 0.3rem;
    }
    #examTab .nav-link.active,
    #examTab .nav-link:focus,
    #examTab .nav-link:hover {
        border-bottom: 3px solid #4a6cfa;
        border-left: none;
        background: #f4f7ff;
    }
    .patient-avatar {
    width: 100px;
    height: 125px;
    margin-left: 30px;
    object-fit: cover;
    border: 3px solid white;
}
    .card-body {
    width: 100%;
    padding-left: 0 !important;
    padding-right: 0 !important;
}
    #mainComplaintForm {
    width: 100%;
}
}

    </style>
</head>

<body>
    <div class="container-fluid px-0" style="max-width:100vw;">
  <div class="row g-0">
    <div class="col-lg-8 col-12 px-0">
      <div class="bg-white shadow-sm" style="min-height:100vh;">
        <div class="border-bottom py-3 px-4 d-flex align-items-center" style="background:var(--bs-primary,#4e73df);">
          <i class="fas fa-procedures text-white me-2"></i>
          <span class="fw-bold text-white fs-5">In Progress</span>
          <span id="examDuration" class="badge bg-warning text-dark ms-auto"></span>
        </div>
        <div class="row g-0">
          <div class="col-12 col-md-3 border-end bg-light">
            <ul class="nav flex-md-column flex-row nav-pills py-4 px-2 gap-2" id="examTab" role="tablist" style="min-height:100vh;">
              <li class="nav-item" role="presentation">
                <button class="nav-link active text-start" id="step1-tab" data-bs-toggle="pill" data-bs-target="#step1" type="button" role="tab">
                  <i class="fas fa-user-md me-2"></i>  Triệu chứng
                </button>
              </li>
              <!-- Các bước khác tạm thời bỏ đi -->
            </ul>
          </div>
          <div class="col-12 col-md-9 px-0">
            <div class="tab-content" id="examTabContent">
              <div class="tab-pane fade show active" id="step1" role="tabpanel">
                <!-- Giữ nguyên form hỏi bệnh và các modal liên quan -->
                <form id="mainComplaintForm">
                  <div class="card shadow-sm mb-4 border-0">
                    <div class="card-body px-4 py-4">
                      <form id="mainComplaintForm" class="row g-4">
                        <div class="col-12 col-md-6 col-lg-4">
                          <label class="form-label fw-semibold">Lý do đến khám</label>
                          <input type="text" class="form-control bg-light" id="mainComplaint" readonly>
                        </div>
                        <div class="col-12 col-md-6 col-lg-4">
                          <div class="d-flex align-items-center justify-content-between">
                            <label class="form-label fw-semibold mb-0">Dị ứng</label>
                            <button type="button" class="btn btn-link btn-sm text-primary" onclick="openEditAllergiesModal()" title="Chỉnh sửa dị ứng">
                              <i class="fas fa-pen"></i>
                            </button>
                          </div>
                          <ul id="allergiesList" class="plain-list mb-0"></ul>
                        </div>
                        <div class="col-12 col-md-6 col-lg-4">
                          <div class="d-flex align-items-center justify-content-between">
                            <label class="form-label fw-semibold mb-0">Bệnh mãn tính</label>
                            <button type="button" class="btn btn-link btn-sm text-primary" onclick="openEditChronicModal()" title="Chỉnh sửa bệnh mãn tính">
                              <i class="fas fa-pen"></i>
                            </button>
                          </div>
                          <ul id="chronicDiseasesList" class="plain-list mb-0"></ul>
                        </div>
                        <div class="col-12">
                          <label class="form-label fw-semibold">Triệu chứng</label>
                          <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="openSymptomModal()">
                              <i class="fas fa-plus"></i> Thêm triệu chứng
                            </button>
                          </div>
                          <ul id="symptomsUl" class="list-group symptom-list"></ul>
                        </div>
                      </form>
                    </div>
                  </div>
                </form>
                <!-- Modal Thêm/Sửa Triệu Chứng, Modal chỉnh sửa dị ứng, Modal chỉnh sửa bệnh mãn tính giữ nguyên -->
                <!-- ...modal code giữ nguyên... -->
              </div>
              <!-- Các tab-pane khác tạm thời bỏ đi -->
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-4 d-none d-lg-block bg-white border-end" id="patientInfoContainer"></div>
  </div>
</div>

    <!-- Bootstrap JS -->
    <script src="../dashboard/assets/js/core/libs.min.js"></script>
    <script src="../dashboard/assets/js/kivicare.js"></script>

    <script>
        // Get appointment ID from URL or use default for demo
        const appointmentId = new URLSearchParams(window.location.search).get('id') || 1;
        let selectedTests = [];

        // Sample test data
        const availableTests = [
            { id: 1, name: "Complete Blood Count (CBC)", category: "Hematology" },
            { id: 2, name: "Basic Metabolic Panel", category: "Chemistry" },
            { id: 3, name: "Lipid Panel", category: "Chemistry" },
            { id: 4, name: "Thyroid Function Tests", category: "Endocrinology" },
            { id: 5, name: "Liver Function Tests", category: "Chemistry" },
            { id: 6, name: "Kidney Function Tests", category: "Chemistry" },
            { id: 7, name: "Blood Glucose", category: "Chemistry" },
            { id: 8, name: "Hemoglobin A1c", category: "Chemistry" },
            { id: 9, name: "Vitamin D", category: "Vitamins" },
            { id: 10, name: "Vitamin B12", category: "Vitamins" }
        ];

        // Sample patient data for demonstration
        const samplePatientData = {
            patientEntityId: "P001",
            patientEntityFullName: "John Smith",
            patientEntityPhoneNumber: "+1 234-567-8900",
            patientEntityEmail: "john.smith@email.com",
            patientEntityAddress: "123 Main St, Cityville, State 12345",
            patientEntityBirthdate: "1988-05-15",
            patientEntityAvatarUrl: "https://via.placeholder.com/120x120/667eea/white?text=JS",
            date: "2024-01-15 09:30:00",
            symptoms: "",
            diagnosis: ""
        };

        let allergies = ["Penicillin", "Hải sản"];
let chronicDiseases = ["Tăng huyết áp", "Tiểu đường"];
let symptoms = [];

// Render allergies & chronic diseases
function renderAllergies() {
  const ul = document.getElementById('allergiesList');
  ul.innerHTML = allergies.length
    ? allergies.map(a => `<li>${a}</li>`).join('')
    : '<li class="text-muted">Không có</li>';
}
function renderChronic() {
  const ul = document.getElementById('chronicDiseasesList');
  ul.innerHTML = chronicDiseases.length
    ? chronicDiseases.map(c => `<li>${c}</li>`).join('')
    : '<li class="text-muted">Không có</li>';
}

// Modal edit allergies
function openEditAllergiesModal() {
  document.getElementById('allergiesInput').value = allergies.join('\n');
  new bootstrap.Modal(document.getElementById('allergiesModal')).show();
}
function saveAllergies(e) {
  e.preventDefault();
  allergies = document.getElementById('allergiesInput').value.split('\n').map(s => s.trim()).filter(Boolean);
  renderAllergies();
  bootstrap.Modal.getInstance(document.getElementById('allergiesModal')).hide();
}

// Modal edit chronic
function openEditChronicModal() {
  document.getElementById('chronicInput').value = chronicDiseases.join('\n');
  new bootstrap.Modal(document.getElementById('chronicModal')).show();
}
function saveChronic(e) {
  e.preventDefault();
  chronicDiseases = document.getElementById('chronicInput').value.split('\n').map(s => s.trim()).filter(Boolean);
  renderChronic();
  bootstrap.Modal.getInstance(document.getElementById('chronicModal')).hide();
}

// Triệu chứng
function renderSymptoms() {
  const ul = document.getElementById('symptomsUl');
  if (!symptoms.length) {
    ul.innerHTML = `<li class="list-group-item text-muted">Chưa có triệu chứng nào</li>`;
    return;
  }
  ul.innerHTML = symptoms.map((s, idx) => `
    <li class="list-group-item d-flex justify-content-between align-items-start">
      <div class="d-flex align-items-start gap-2">
        <i class="fas fa-exclamation-circle"></i>
        <div>
          <strong>${s.symptom_name}</strong>
          <span class="text-muted small ms-2">${s.duration_description || ''}</span>
          <span class="badge bg-secondary ms-2">${s.severity || ''}</span>
          <div class="small text-muted">${s.description || ''}</div>
        </div>
      </div>
      <div>
        <button type="button" class="btn btn-link btn-sm text-primary" onclick="editSymptom(${idx})" title="Sửa"><i class="fas fa-pen"></i></button>
        <button type="button" class="btn btn-link btn-sm text-danger" onclick="deleteSymptom(${idx})" title="Xóa"><i class="fas fa-trash"></i></button>
      </div>
    </li>
  `).join('');
}

// Modal thêm/sửa triệu chứng
function openSymptomModal(idx = null) {
  document.getElementById('symptomForm').reset();
  document.getElementById('symptomIndex').value = idx !== null ? idx : '';
  if (idx !== null) {
    const s = symptoms[idx];
    document.getElementById('symptomName').value = s.symptom_name;
    document.getElementById('durationDescription').value = s.duration_description;
    document.getElementById('severity').value = s.severity;
    document.getElementById('description').value = s.description;
  }
  new bootstrap.Modal(document.getElementById('symptomModal')).show();
}
function saveSymptom(e) {
  e.preventDefault();
  const idx = document.getElementById('symptomIndex').value;
  const s = {
    symptom_name: document.getElementById('symptomName').value,
    duration_description: document.getElementById('durationDescription').value,
    severity: document.getElementById('severity').value,
    description: document.getElementById('description').value
  };
  if (idx === '') {
    symptoms.push(s);
  } else {
    symptoms[idx] = s;
  }
  renderSymptoms();
  bootstrap.Modal.getInstance(document.getElementById('symptomModal')).hide();
}
function editSymptom(idx) {
  openSymptomModal(idx);
}
function deleteSymptom(idx) {
  if (confirm('Xóa triệu chứng này?')) {
    symptoms.splice(idx, 1);
    renderSymptoms();
  }
}

// Khởi tạo dữ liệu mẫu và render
document.addEventListener('DOMContentLoaded', function () {
  renderAllergies();
  renderChronic();
  renderSymptoms();
});
        // Initialize page
        document.addEventListener('DOMContentLoaded', function () {
            loadPatientData();
            loadAvailableTests();
            updateStartTime();
            setupFormValidation();
        });

        // Replace this function in your HTML file
        function loadPatientData() {
            const appointmentId = new URLSearchParams(window.location.search).get('id') || 1;
            fetch(`/appointments/in-progress/${appointmentId}`)
                .then(response => response.json())
                .then(data => renderPatientInfo(data))
                .catch(error => {
                    console.error('Error loading patient data:', error);
                    document.getElementById('patientInfoContainer').innerHTML = '<div class="alert alert-danger">Error loading patient information.</div>';
                });
        }
        function renderPatientInfo(data) {
            const container = document.getElementById('patientInfoContainer');
            container.innerHTML = `
        <div class="card mb-3" style="padding-left:0;margin-left:1.7rem ;">
            <div class="card-header bg-primary text-white">
                <i class="fas fa-user me-2"></i>Patient Profile
            </div>
            <div class="card-body text-center">
                <img src="${data.patientEntityAvatarUrl || 'https://via.placeholder.com/120x120/667eea/white?text=U'}" class="patient-avatar mb-2">
                <h5 class="mb-1">${data.patientEntityFullName || ''}</h5>
                <div class="text-muted mb-2">
                    ${data.patientEntityGender === 'MALE' ? 'Male' : data.patientEntityGender === 'FEMALE' ? 'Female' : ''}
                    ${data.patientEntityBirthdate ? ', ' + calculateAge(data.patientEntityBirthdate) + ' years' : ''}
                </div>
                <div class="mb-2"><i class="fas fa-phone me-1"></i> ${data.patientEntityPhoneNumber || ''}</div>
                <div class="mb-2"><i class="fas fa-envelope me-1"></i> ${data.patientEntityEmail || ''}</div>
                <div class="mb-2"><i class="fas fa-map-marker-alt me-1"></i> ${data.patientEntityAddress || ''}</div>
                <div class="mb-2"><i class="fas fa-id-card me-1"></i> ID: ${data.patientEntityId || ''}</div>
            </div>
        </div>
    `;
            if (data.durationMinutes) {
                startCountdown(data.durationMinutes);
            }
        }
        // Helper to calculate age from birthdate string (yyyy-MM-dd)
        function calculateAge(birthdate) {
            const birth = new Date(birthdate);
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const m = today.getMonth() - birth.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }

        function startCountdown(durationMinutes) {
            const durationElem = document.getElementById('examDuration');
            let remaining = durationMinutes * 60; // seconds

            function updateTimer() {
                const min = Math.floor(remaining / 60);
                const sec = remaining % 60;
                durationElem.textContent = `Time left: ${min}:${sec.toString().padStart(2, '0')} min`;
                if (remaining > 0) {
                    remaining--;
                    setTimeout(updateTimer, 1000);
                } else {
                    durationElem.textContent = 'Time is up!';
                    durationElem.classList.remove('bg-warning', 'text-dark');
                    durationElem.classList.add('bg-danger', 'text-white');
                }
            }
            updateTimer();
        }

        function loadAvailableTests() {
            const testsList = document.getElementById('testsList');
            testsList.innerHTML = availableTests.map(test => `
                <div class="test-item" onclick="toggleTest(${test.id}, '${test.name}')">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${test.name}</h6>
                            <small class="text-muted">${test.category}</small>
                        </div>
                        <i class="fas fa-plus"></i>
                    </div>
                </div>
            `).join('');
        }

        function updateStartTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
            document.getElementById('startTime').textContent = `Started at ${timeString}`;
        }

        function setupFormValidation() {
            const symptomsField = document.getElementById('symptoms');
            const diagnosisField = document.getElementById('diagnosis');
            const vitalFields = ['heartRate', 'temperature', 'bloodPressure', 'oxygenSat'];

            symptomsField.addEventListener('input', function () {
                if (this.value.trim()) {
                    updateTimelineStep('symptomsStep', 'Symptoms documented');
                }
            });

            diagnosisField.addEventListener('input', function () {
                if (this.value.trim()) {
                    updateTimelineStep('diagnosisStep', 'Diagnosis completed');
                }
            });

            vitalFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                field.addEventListener('input', function () {
                    checkVitalsCompletion();
                });
            });
        }

        function checkVitalsCompletion() {
            const vitalFields = ['heartRate', 'temperature', 'bloodPressure', 'oxygenSat'];
            const completedFields = vitalFields.filter(fieldId => {
                const field = document.getElementById(fieldId);
                return field.value.trim() !== '';
            });

            if (completedFields.length > 0) {
                updateTimelineStep('vitalsStep', `${completedFields.length}/4 vital signs recorded`);
            }
        }

        function updateTimelineStep(stepId, message) {
            const step = document.getElementById(stepId);
            if (step) {
                step.classList.add('active');
                const timeText = step.querySelector('p');
                if (timeText) {
                    const now = new Date();
                    const timeString = now.toLocaleTimeString('en-US', {
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: true
                    });
                    timeText.textContent = `${message} at ${timeString}`;
                    timeText.classList.remove('text-muted');
                    timeText.classList.add('text-success');
                }
            }
        }

        function completeExamination() {
            const symptoms = document.getElementById('symptoms').value.trim();
            const diagnosis = document.getElementById('diagnosis').value.trim();

            if (!symptoms || !diagnosis) {
                alert('Please fill in both symptoms and diagnosis before completing the examination.');
                return;
            }

            if (confirm('Are you sure you want to complete this examination?')) {
                updateAppointment({ status: 'COMPLETED' }); updateTimelineStep('completionStep', 'Examination completed');

                const actionButtons = document.querySelectorAll('.btn:not([onclick*="goBack"])');
                actionButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('opacity-50');
                });

                setTimeout(() => {
                    alert('Examination completed successfully!');
                    window.location.href = '/doctor/appointments';
                }, 1000);
            }
        }

        function waitForTestResults() {
            if (confirm('Pause examination to wait for test results?')) {
                updateAppointment({ status: 'WAITING_RESULT' });
                alert('Examination paused. Patient will be notified when results are available.');
            }
        }

        function requestTests() {
            const modal = new bootstrap.Modal(document.getElementById('testRequestModal'));
            modal.show();
        }

        function prescribeMedication() {
            if (confirm('Complete examination and proceed to prescription?')) {
                updateAppointment({ status: 'COMPLETED', type: 'prescribed' });
                alert('Redirecting to prescription module...');
            }
        }

        function toggleTest(testId, testName) {
            const testElement = event.currentTarget;
            const icon = testElement.querySelector('i');

            if (selectedTests.includes(testId)) {
                selectedTests = selectedTests.filter(id => id !== testId);
                testElement.classList.remove('selected');
                icon.className = 'fas fa-plus';
            } else {
                selectedTests.push(testId);
                testElement.classList.add('selected');
                icon.className = 'fas fa-check';
            }

            updateSelectedTestsDisplay();
        }

        function updateSelectedTestsDisplay() {
            const selectedTestsDiv = document.getElementById('selectedTests');

            if (selectedTests.length === 0) {
                selectedTestsDiv.innerHTML = 'No tests selected yet';
                selectedTestsDiv.className = 'alert alert-info';
            } else {
                const selectedTestNames = selectedTests.map(id => {
                    const test = availableTests.find(t => t.id === id);
                    return test ? test.name : '';
                }).filter(name => name);

                selectedTestsDiv.innerHTML = `
                    <strong>Selected Tests (${selectedTests.length}):</strong><br>
                    ${selectedTestNames.map(name => `• ${name}`).join('<br>')}
                `;
                selectedTestsDiv.className = 'alert alert-success';
            }
        }

        function searchTests() {
            const searchTerm = document.getElementById('testSearch').value.toLowerCase();
            const filteredTests = availableTests.filter(test =>
                test.name.toLowerCase().includes(searchTerm) ||
                test.category.toLowerCase().includes(searchTerm)
            );

            const testsList = document.getElementById('testsList');
            testsList.innerHTML = filteredTests.map(test => `
                <div class="test-item ${selectedTests.includes(test.id) ? 'selected' : ''}" 
                     onclick="toggleTest(${test.id}, '${test.name}')">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${test.name}</h6>
                            <small class="text-muted">${test.category}</small>
                        </div>
                        <i class="fas fa-${selectedTests.includes(test.id) ? 'check' : 'plus'}"></i>
                    </div>
                </div>
            `).join('');
        }

        function submitTestRequest() {
            if (selectedTests.length === 0) {
                alert('Please select at least one test.');
                return;
            }

            console.log('Requesting tests:', selectedTests);

            const modal = bootstrap.Modal.getInstance(document.getElementById('testRequestModal'));
            modal.hide();

            alert(`Successfully requested ${selectedTests.length} lab test(s). Results will be available within 24-48 hours.`);

            selectedTests = [];
            updateSelectedTestsDisplay();
            loadAvailableTests();
        }


        function goBack() {
            if (confirm('Are you sure you want to leave this examination? Any unsaved changes will be lost.')) {
                window.location.href = '/doctor/appointments';
            }
        }
    </script>
</body>
</html>